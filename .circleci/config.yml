version: 2.1
jobs:
  build:
    docker:
      - image: circleci/python:3.7
    steps:
      - checkout
      - run:
          name: pack python folder
          command: |
            zip metaupload.zip metaupload.py
            mkdir /tmp/resources
            mv playbooks/aws_role/policy.json /tmp/resources
            mv metaupload.zip /tmp/resources
      - persist_to_workspace:
          root: /tmp/resources
          paths:
            - policy.json
            - metaupload.zip

  deploy:
    docker:
      - image: circleci/python:3.7
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/resources
      - run:
          name: install dependencies
          command: |
            sudo pip install -r requirements.txt
      - run:
          name: deploy
          command: |
            opera deploy demo demo_use_case.yml

  test:
    docker:
      - image: circleci/python:3.7.2
    steps:
      - run:
          name: install dependencies
          command: |
            sudo pip3 install awscli
      - run:
          name: create project
          command: |
            curl -X POST localhost:20000/projects
      - run:
          name: create testartifact
          command: |
            curl -X POST localhost:20000/testartifacts
      - run:
          name: verify content
          command: |
            curl -X POST localhost:20000/deployments
      
workflows:
  version: 2

  build-test-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
      # - test:
      #     requires:
      #       - deploy